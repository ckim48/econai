{% extends "base.html" %}
{% block content %}
<style>
    #chatContent {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .chat-bubble {
        max-width: 75%;
        padding: 10px 15px;
        border-radius: 15px;
        line-height: 1.5;
        font-size: 14px;
    }

    .chat-bubble.user {
        align-self: flex-end;
        background-color: #d1e7dd;
        color: #0f5132;
        border-top-right-radius: 0;
    }

    .chat-bubble.ai {
        align-self: flex-start;
        background-color: #ebfbfe;
        color: #455bea;
        border-top-left-radius: 0;
    }
      .table {
        margin: 0;
        border-collapse: collapse;
    }

    .table th,
    .table td {
        padding: 15px; /* Add padding for more space */
        font-size: 14px;
        text-align: center; /* Center align content */
        vertical-align: middle; /* Vertically center content */
    }

    .table th {
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: black;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f9f9f9;
    }

    .table-hover tbody tr:hover {
        background-color: #f1f1f1;
    }

    /* Sticky Header */
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 1;
    }

    /* Header Styles */
    .bg-gradient {
        background: linear-gradient(90deg, #455bea, #5468ff);
        color: #fff;
    }

    /* Custom Column Styles */
    .text-center {
        text-align: center;
    }
    /* FullCalendar Date Styles */
    .fc-daygrid-day-number {
        color: black !important; /* Set the color of dates to black */
        text-decoration: none !important; /* Remove underline */
    }

    .fc-daygrid-day:hover .fc-daygrid-day-number {
        text-decoration: none !important; /* Ensure no underline on hover */
    }

    /* Additional Customization (optional) */
    .fc-daygrid-day {
        border: 1px solid #ddd;

    }
    .fc-col-header-cell-cushion{
        color:black !important;
        text-decoration:none;
    }
    .card-header h5{
        font-size: 23px;
        text-align:center;
    }
    /* Styles for Income Events */
.income-event {
    background-color: #d4edda !important; /* Light green */
    border-color: #c3e6cb !important; /* Green border */
    color: #155724 !important; /* Dark green text */
}

/* Styles for Expense Events */
.expense-event {
    background-color: #f8d7da !important; /* Light red */
    border-color: #f5c6cb !important; /* Red border */
    color: #721c24 !important; /* Dark red text */
}
    .fc-h-event .fc-event-main{
        color: black;
    }

</style>
<div class="container mt-5">
    <h1 class="text-center mb-5 text-gradient">ðŸ‘‹ Hello, {{ username }}</h1>
    <div class="row g-4">
        <!-- Balance Card -->
        <div class="col-lg-12 d-flex justify-content-center">
            <div class="card shadow-lg border-0 position-relative mx-auto" style="width: 100%; max-width: 400px; background-color: #fdfdfd;">
                <button
                    class="btn btn-gradient btn-sm rounded-pill shadow-sm position-absolute top-0 end-0 m-3"
                    data-bs-toggle="modal"
                    data-bs-target="#addRecordModal">
                    + Add Record
                </button>
                <div class="card-body text-center">
                    <h5 class="text-muted">Total Balance</h5>
                    <h2 class="text-gradient fw-bold">${{ balance }}</h2>
                    <div class="d-flex justify-content-around mt-4">
                        <div>
                            <h6 class="text-muted">Income</h6>
                            <p class="text-success fw-bold">${{ income }}</p>
                        </div>
                        <div>
                            <h6 class="text-muted">Expense</h6>
                            <p class="text-danger fw-bold">${{ expense }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction and Calendar -->
    <div class="row g-4 mt-4">
        <!-- Transaction Table -->
<!-- Transaction Table -->
<div class="col-lg-5">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient text-white">
            <h5 class="mb-0">Transaction Records</h5>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover table-striped mb-0 align-middle">
                <thead class="sticky-top bg-gradient text-white">
                    <tr>
                        <th scope="col" class="py-3" style="width: 10%;">Type</th>
                        <th scope="col" class="py-3" style="width: 20%;">Category</th>
                        <th scope="col" class="py-3" style="width: 20%;">Amount</th>
                        <th scope="col" class="py-3" style="width: 30%;">Description</th>
                        <th scope="col" class="py-3" style="width: 20%;">Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                    <tr>
                        <td class="fw-bold text-primary">{{ record.type }}</td>
                        <td>{{ record.category }}</td>
                        <td class="text-{{ 'success' if record.type == 'Income' else 'danger' }} fw-bold">
                            ${{ record.amount }}
                        </td>
                        <td class="text-muted">{{ record.description }}</td>
                        <td>{{ record.date }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>



        <!-- Calendar -->
        <div class="col-lg-7">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0">Calendar</h5>
                </div>
                <div class="card-body">
                    <div id="calendar" class="rounded border mt-3" style="background-color: #fdfdfd;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Modal for Adding Record -->
<div class="modal fade" id="addRecordModal" tabindex="-1" aria-labelledby="addRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-gradient text-white">
                <h5 class="modal-title" id="addRecordModalLabel">Add Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addRecordForm">
                    <div class="mb-3">
                        <label for="recordType" class="form-label">Type</label>
                        <select class="form-select" id="recordType" required>
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="recordCategory" class="form-label">Category</label>
                        <input type="text" class="form-control" id="recordCategory" placeholder="e.g., Food, Rent" required>
                    </div>
                    <div class="mb-3">
                        <label for="recordAmount" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="recordAmount" placeholder="Enter amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="recordDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="recordDescription" rows="2" placeholder="Enter description"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="recordDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="recordDate" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-gradient" id="saveRecordBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Chat Button -->
<div id="chat-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
    <button
        id="chatBtn"
        class="btn btn-gradient rounded-circle shadow-lg"
        style="width: 60px; height: 60px; font-size: 24px;">
        ðŸ’¬
    </button>
    <div
        id="chatBox"
        class="card shadow-lg d-none"
        style="width: 500px; height: 600px; position: absolute; bottom: 80px; right: 0; border-radius: 1rem; overflow: hidden; background-color: #fdfdfd;">
        <div class="card-header bg-gradient text-white">
            <h6 class="mb-0">Chat Assistant</h6>
        </div>
        <div id="chatContent" class="card-body overflow-auto p-3" style="height: 400px; background-color: #f8f9fa;">
            <!-- Chat content will be dynamically inserted here -->
        </div>
        <div class="card-footer">
            <div class="input-group">
                <input
                    type="text"
                    id="chatInput"
                    class="form-control"
                    placeholder="Type a message..."
                />
                <button id="sendBtn" class="btn btn-gradient">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar Integration -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
 const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: [
            {% for record in records %}
            {
                title: "{{ record.type }}: ${{ record.amount }}",
                start: "{{ record.date }}",
                description: "{{ record.description }}",
                className: "{{ 'income-event' if record.type == 'Income' else 'expense-event' }}"
            },
            {% endfor %}
        ]
    });
    calendar.render();


    // Save Record Button Handler
    document.getElementById('saveRecordBtn').addEventListener('click', () => {
        const type = document.getElementById('recordType').value;
        const category = document.getElementById('recordCategory').value;
        const amount = document.getElementById('recordAmount').value;
        const description = document.getElementById('recordDescription').value;
        const date = document.getElementById('recordDate').value;

        if (type && category && amount && date) {
            fetch('/add_record', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, category, amount, description, date })
            }).then(response => response.json()).then(data => {
                if (data.status === 'success') {
                    alert('Record added successfully!');
                    location.reload();
                } else {
                    alert('Failed to add record.');
                }
            });
        }
    });

   const chatBtn = document.getElementById('chatBtn');
    const chatBox = document.getElementById('chatBox');
    const chatContent = document.getElementById('chatContent');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    // Toggle chat visibility
    chatBtn.addEventListener('click', () => {
        chatBox.classList.toggle('d-none');
    });

    // Function to format AI responses
    const formatResponse = (response) => {
        // Split response into lines for better readability
        const lines = response.split(/(\d+\.\s)/).filter(Boolean);
        return lines.map(line => {
            if (/^\d+\.\s/.test(line)) {
                // Format numbered points with a bold number
                return `<p style="margin-left: 1em; text-indent: -1em;"><strong>${line}</strong></p>`;
            } else {
                return `<p style="margin-left: 2em;">${line}</p>`;
            }
        }).join('');
    };

    // Function to send a message
    const sendMessage = async () => {
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;

        // Add user message to chat
        chatContent.innerHTML += `<div class="chat-bubble user">You: ${userMessage}</div>`;
        chatInput.value = '';

        // Scroll to the latest message
        chatContent.scrollTop = chatContent.scrollHeight;

        try {
            // Send message to the backend
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userMessage }),
            });

            const data = await response.json();
            const aiMessage = formatResponse(data.reply);

            // Add formatted AI response to chat
            chatContent.innerHTML += `<div class="chat-bubble ai">Budget Helper AI: ${aiMessage}</div>`;
        } catch (error) {
            chatContent.innerHTML += `<div class="chat-bubble ai">Error: Unable to process your message.</div>`;
        }

        // Scroll to the latest message
        chatContent.scrollTop = chatContent.scrollHeight;
    };

    // Attach click event to send button
    sendBtn.addEventListener('click', sendMessage);

    // Attach keydown event to input field for Enter key
    chatInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault(); // Prevent the default behavior of Enter (form submission)
            sendMessage(); // Call the sendMessage function
        }
    });
});

</script>
{% endblock %}
